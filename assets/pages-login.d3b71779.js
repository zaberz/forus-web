import{o as e,c as a,w as t,a6 as n,i as s,a7 as l,V as o,a8 as u,a9 as i,aa as c,ab as r,D as d,y as p,ac as m,$ as f,a as x,b as w,d as v,ad as h,j as y,F as b,ae as g,I as _,af as j}from"./index-aa1ee2fe.js";import{_ as k}from"./_plugin-vue_export-helper.1b428a4d.js";import{u as N,a as P}from"./index.603a3602.js";import{c as C,a as V}from"./setting.c0f5f2be.js";import{r as I,p as U}from"./login.ab98dc66.js";import{o as A}from"./uni-app.es.363de114.js";const E=k({},[["render",function(l,o){const u=s;return e(),a(u,{class:"app text-base"},{default:t((()=>[n(l.$slots,"default")])),_:3})}]]),L={__name:"login",setup(n){const k=l(!0),L=o.pipe(u((e=>!!e.wxPhone))),R=N(L),T=N(o),$=l({wxAvatar:"",wxName:"",wxPhone:"",init:0});P(o.subscribe((({wxName:e,wxPhone:a})=>{$.value.wxName=e,$.value.wxPhone=a})));const B=new i((e=>{A((a=>{let{scene:t}=a;t=decodeURIComponent(decodeURIComponent(t)),console.log(t);let n={};t.split("&").forEach((e=>{let a=e.split(":");n[a[0]]=a[1]})),n.code?e.next(n.code):e.next(!1),e.complete()}))})).pipe(c()),D=B.pipe(u((e=>!!e)));async function F(){let e={...$.value};e.wxPhone||delete e.wxPhone,await U(T.value,e)}C([D,L,o,B]).subscribe((async([e,a,t,n])=>{e&&a&&(await async function(e,a){await postLoginCode({code:e,customer:a.id})}(n,t),H()),k.value=!1}));const G=N(V),J=r((()=>k.value||!$.value.wxName));async function K(e){if(!e.detail||!e.detail.code)return void d({title:"请授权手机号",icon:"error"});k.value=!0;let a=(await I({url:"https://auth.ruaaaa.com/phone",params:{code:e.detail.code,appid:G.value}})).phone_info.phoneNumber;$.value.wxPhone=a,$.value.init=1,await F(),H()}function q(){setTimeout((()=>{g().select("#nickname-input").fields({properties:["value"]}).exec((e=>{var a;const t=null==(a=null==e?void 0:e[0])?void 0:a.value;$.value.wxName=t}))}),500)}async function z(){await F(),k.value=!1,H()}function H(){d({title:"登录成功",icon:"success"}),setTimeout((()=>{p().length>1?m():f({url:"/pages/index/index"})}),3e3)}return(n,l)=>{const o=s,u=_,i=j;return e(),a(E,null,{default:t((()=>[k.value?(e(),a(o,{key:0,class:"flex flex-col justify-center item-center h-screen bg-gray-100"},{default:t((()=>[x(o,null,{default:t((()=>[w("初始化中，请稍候")])),_:1})])),_:1})):(e(),v(b,{key:1},[x(o,{class:"flex justify-between bg-white py-2 px-4 items-center mt-2 shadow"},{default:t((()=>[x(o,null,{default:t((()=>[w("昵称")])),_:1}),x(u,{id:"nickname-input",class:"text-right py-2 flex-1",name:"name",modelValue:$.value.wxName,"onUpdate:modelValue":l[0]||(l[0]=e=>$.value.wxName=e),type:"nickname",placeholder:"请输入昵称",onBlur:q},null,8,["modelValue"])])),_:1}),h(R)?(e(),a(i,{key:0,onClick:z,class:"rounded-full w-auto mt-8 bg-gray-900 py-2 mx-4 text-white"},{default:t((()=>[w("授权登陆 ")])),_:1})):(e(),a(i,{key:1,disabled:h(J),class:"rounded-full w-auto mt-8 bg-gray-900 py-2 mx-4 text-white","open-type":"getPhoneNumber",onGetphonenumber:K},{default:t((()=>[w("授权并登陆 ")])),_:1},8,["disabled"])),h(J)?(e(),a(o,{key:2,class:"text-center mt-2"},{default:t((()=>[w("请先完善昵称信息 ")])),_:1})):y("v-if",!0)],64))])),_:1})}}};export{L as default};
